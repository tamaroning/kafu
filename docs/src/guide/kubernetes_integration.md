# Kubernetes Integration

This guide explains how to deploy Kafu services on Kubernetes clusters. Kafu provides the `kafu kustomize` command to generate Kubernetes manifests from your Kafu configuration file.

## Prerequisites

Before deploying Kafu services to Kubernetes, ensure you have:

- A running Kubernetes cluster with `kubectl` configured
- [Kustomize](https://github.com/kubernetes-sigs/kustomize) installed (typically included with `kubectl`)
- Kubernetes nodes labeled with `kafu-node` matching your node IDs (see [Node Labeling](#node-labeling))

## Configuration for Kubernetes

When deploying to Kubernetes, you should configure your `kafu-config.yaml` file with Kubernetes-specific settings:

### Using URL for WebAssembly Binary

For Kubernetes deployments, it's recommended to use `app.url` instead of `app.path` to download the WebAssembly binary from a URL (e.g., from object storage like S3 or GCS). This allows the binary to be accessible from any Pod in the cluster.

### Using Service Names for Addresses

In the `nodes` section, you can use Kubernetes service names for node addresses. The `kafu kustomize` command generates Services with names following the pattern `kafu-server-<node-id>`, which can be referenced as:

- `kafu-server-<node-id>.<namespace>.svc.cluster.local` (fully qualified)
- `kafu-server-<node-id>` (within the same namespace)

If you deploy multiple instances of the same Kafu config in the same namespace using `--instance-id`, resource names get a prefix and Service names become:

- `<instance-id>-kafu-server-<node-id>`

### Example Configuration

```yaml
name: kafu-k8s-example
app:
  # Use URL for Kubernetes deployments
  url: https://example.com/path/to/main.wasm
  args: [960, 540]
nodes:
  cloud1:
    # Use Kubernetes service name
    address: kafu-server-cloud1.default.svc.cluster.local
    port: 50051
  edge1:
    address: kafu-server-edge1.default.svc.cluster.local
    port: 50051
```

## Generating Kubernetes Manifests

Use the `kafu kustomize` command to generate Kubernetes manifests from your configuration:

```sh
kafu kustomize build kafu-config.yaml
```

This command generates Pod and Service resources for each node defined in your configuration. For detailed information about the generated resources, see [Kafu Kustomize](../cli/kustomize.md).

### Deploying Multiple Instances (Optional)

If you want to deploy the same Kafu config multiple times in the same namespace, pass an instance ID:

```sh
kafu kustomize build kafu-config.yaml --instance-id staging > kafu-manifest-staging.yaml
kafu kustomize build kafu-config.yaml --instance-id dev > kafu-manifest-dev.yaml
```

This makes resource names unique (via a name prefix) and adds the `kafu-instance=<instance-id>` label to Pods and Services, so each Service selects only Pods from the same instance.

### Saving the Manifest

You can save the generated manifest to a file:

```sh
kafu kustomize build kafu-config.yaml > kafu-manifest.yaml
```

## Deploying to Kubernetes

Once you have generated the manifest, deploy it to your cluster:

```sh
# Apply the manifest
kubectl apply -f kafu-manifest.yaml

# Or pipe directly from kafu kustomize
kafu kustomize build kafu-config.yaml | kubectl apply -f -
```

### Verifying Deployment

Check that the Pods and Services are created:

```sh
# List Pods
kubectl get pods -l component=kafu-server

# List Services
kubectl get services -l component=kafu-server

# Check Pod logs
kubectl logs -l component=kafu-server --all-containers=true
```

If you used `--instance-id`, you can additionally filter by instance:

```sh
kubectl get pods -l component=kafu-server,kafu-instance=staging
kubectl get services -l component=kafu-server,kafu-instance=staging
```

Note: the generated ConfigMap is labeled with `kafu-service-name=<service-name>` (and `kafu-instance=<instance-id>` when set), so you can list it like:

```sh
kubectl get configmaps -l kafu-service-name=kafu-k8s-example
kubectl get configmaps -l kafu-service-name=kafu-k8s-example,kafu-instance=staging
```

## Node Labeling

Each Pod generated by `kafu kustomize` uses a node selector to ensure it runs on the correct Kubernetes node:

```yaml
nodeSelector:
  kafu-node: <placement-or-node-id>
```

By default, when the `placement` field is omitted in the Kafu config, `kafu kustomize` uses the **node ID** as the placement key. This preserves the original 1:1 mapping between Kafu nodes and Kubernetes nodes.

If you want to run **multiple Kafu nodes on the same Kubernetes node**, you can specify the same `placement` value for multiple nodes in your Kafu config. For example:

```yaml
nodes:
  cloud1a:
    address: kafu-server-cloud1a
    port: 50051
    placement: group1
  cloud1b:
    address: kafu-server-cloud1b
    port: 50052
    placement: group1
```

In this case, both `cloud1a` and `cloud1b` will be scheduled onto Kubernetes nodes labeled with `kafu-node=group1`.

**Important**: You must label your Kubernetes nodes with `kafu-node` labels matching the placement values (or node IDs when `placement` is omitted) in your configuration:

```sh
# Label a node for placement key "cloud1" (no placement field)
kubectl label nodes <node-name> kafu-node=cloud1

# Label a node for placement group "group1" (shared by multiple logical nodes)
kubectl label nodes <node-name> kafu-node=group1
```

Verify the labels:

```sh
kubectl get nodes --show-labels | grep kafu-node
```

## Complete Example

Here's a complete workflow for deploying a Kafu service to Kubernetes:

1. **Prepare your WebAssembly binary** and upload it to object storage (e.g., S3, GCS) or a web server.

2. **Create `kafu-config.yaml`**:

```yaml
name: kafu-k8s-example
app:
  url: https://example.com/path/to/main.wasm
  args: []
nodes:
  cloud1:
    address: kafu-server-cloud1.default.svc.cluster.local
    port: 50051
  edge1:
    address: kafu-server-edge1.default.svc.cluster.local
    port: 50051
```

3. **Label your Kubernetes nodes**:

```sh
kubectl label nodes <cloud-node-name> kafu-node=cloud1
kubectl label nodes <edge-node-name> kafu-node=edge1
```

4. **Generate and apply the manifest**:

```sh
kafu kustomize build kafu-config.yaml | kubectl apply -f -
```

5. **Monitor the deployment**:

```sh
kubectl get pods -l component=kafu-server
kubectl logs -f kafu-server-cloud1
```


## Additional Resources

- [Kafu Kustomize](../cli/kustomize.md) - Detailed documentation on the `kafu kustomize` command
- [Kafu Config](../kafu-config.md) - Complete configuration file reference