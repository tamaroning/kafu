<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Kafu Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="A framework for building distributed services in the Cloud-Edge Continuum.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-28bcbf99.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-156469e8.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Kafu Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/tamaroning/kafu/" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="introduction"><a class="header" href="#introduction">Introduction</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p><a href="https://github.com/tamaroning/kafu/">Kafu</a> is a WebAssembly-based framework designed to transparently develop and execute distributed services.<br>Unlike FaaS or traditional client–server models, Kafu allows developers to focus solely on business logic, without explicitly handling service placement, communication, or orchestration.</p>
<p>Kafu compiles C/C++ source code into WebAssembly modules and executes them in a lightweight runtime, enabling portable and efficient distributed computing across cloud and edge environments. Through its built-in binary translator, <a href="#snapify">Snapify</a>, Kafu instruments WebAssembly modules at compile time to support checkpoint/restore, allowing live migration of running programs between nodes without any interruption.</p>
<h2 id="why-webassembly"><a class="header" href="#why-webassembly">Why WebAssembly?</a></h2>
<p>WebAssembly offers portability, allowing the same binary to run across diverse environments including cloud and edge computing. It can be compiled to WebAssembly from various programming languages such as C, C++, Rust, and Go. The runtime is lightweight, supporting fast program startup, suspension, and resumption (checkpoint/restore). By leveraging WebAssembly, Kafu enables a transparent programming model in C/C++ while executing programs in a high-performance runtime environment.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li>A C/C++-to-WebAssembly compiler</li>
<li>C/C++ function attributes for dynamically switching the execution node of a service</li>
<li>Tooling to deploy services as a Kubernetes cluster</li>
</ul>
<h2 id="supported-standards"><a class="header" href="#supported-standards">Supported Standards</a></h2>
<ul>
<li><strong>WebAssembly 2.0</strong>: Kafu fully supports the <a href="https://www.w3.org/TR/wasm-core-2/">WebAssembly 2.0</a> specification, including features such as multi-value returns, reference types, bulk memory operations, and SIMD instructions.</li>
<li><strong>WASI Snapshot preview1</strong>: Kafu implements the WASI snapshot preview1 interface, providing system-level capabilities such as file I/O, environment variables, and clock access to WebAssembly modules.</li>
</ul>
<h2 id="status"><a class="header" href="#status">Status</a></h2>
<p>Kafu is currently in an experimental stage and is not recommended for production use.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>To build WebAssembly services, you need to install Kafu SDK by running the following command:</p>
<p><strong>Supported platforms:</strong> Linux on x86-64 and aarch64 only.</p>
<pre><code class="language-sh">curl -fsSL "https://raw.githubusercontent.com/tamaroning/kafu/refs/heads/main/install.sh" | sh
</code></pre>
<h2 id="check-installation"><a class="header" href="#check-installation">Check Installation</a></h2>
<p>Check if Kafu SDK is installed properly.</p>
<p>By default, the installer appends environment variable exports to your shell profile (for example, <code>~/.bashrc</code> or <code>~/.zshrc</code>). Open a new shell session (or source your profile) so that <code>KAFU_SDK_PATH</code>, <code>WASI_SDK_PATH</code>, and <code>PATH</code> updates take effect.</p>
<p>If you installed with <code>--no-modify-path</code>, set <code>KAFU_SDK_PATH</code>, <code>WASI_SDK_PATH</code>, and update <code>PATH</code> manually.</p>
<pre><code class="language-sh">$ kafu --version
Kafu CLI 0.1.0
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="quick-start"><a class="header" href="#quick-start">Quick Start</a></h1>
<h2 id="installation-1"><a class="header" href="#installation-1">Installation</a></h2>
<p>To install Kafu SDK on your system, please follow the instructions in <a href="#installation">Installation</a>.</p>
<h2 id="build-a-simple-distributed-service"><a class="header" href="#build-a-simple-distributed-service">Build a Simple Distributed Service</a></h2>
<p>Create <code>main.c</code> with the following content:</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;
#include "kafu.h"

void f();

int main() {
  // Starts the program on the cloud node.
  printf("Hello, from cloud!\n");
  fflush(stdout);
}

KAFU_DEST(f, "edge")
KAFU_EXPORT(f)
void f() {
  printf("Hello, from edge!\n");
  fflush(stdout);
}
</code></pre>
<p>This service consists of two nodes: <code>cloud</code> and <code>edge</code>.
When the <code>cloud</code> node executes <code>main</code> first, execution switches to the <code>edge</code> node when calling <code>f()</code>.</p>
<p>Compile it to a Wasm module using <code>kafu clang</code>:</p>
<pre><code class="language-sh">kafu clang main.c -o main.wasm
</code></pre>
<p>Create <code>kafu-config.yaml</code> in the same directory as <code>main.wasm</code> with the following content:</p>
<pre><code class="language-yaml"># Name of the Kafu service.
name: kafu-basic-example
app:
  # Path to the Wasm binary to run.
  path: ./main.wasm
  args: []
  preopened_dir: .
# Node list in the Kafu cluster.
nodes:
  cloud: # Node ID
    # IP address and port of the node.
    address: 127.0.0.1
    # Port of the node.
    port: 50051
  edge:
    address: 127.0.0.1
    port: 50052
</code></pre>
<h2 id="run-the-service-on-a-single-node"><a class="header" href="#run-the-service-on-a-single-node">Run the Service on a Single Node</a></h2>
<p>You can run Kafu programs on a single node using <code>kafu_singlenode</code>.</p>
<pre><code class="language-sh">$ kafu singlenode serve kafu-config.yaml 
2026-02-17T08:03:53.896071Z  INFO Program is starting on cloud1
Hello, from cloud
2026-02-17T08:03:53.926603Z  INFO Migration cloud1 -&gt; edge1 (Entering g)
Hello, from edge
2026-02-17T08:03:53.926623Z  INFO Migration edge1 -&gt; cloud1 (Returning from g)
Hello, from cloud!
2026-02-17T08:03:53.926638Z  INFO Program finished on cloud1
</code></pre>
<p>If you want to deploy the service on multiple nodes using Kubernetes, see <a href="#kubernetes-integration">Kubernetes Integration</a>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="integration-into-build-systems"><a class="header" href="#integration-into-build-systems">Integration into Build Systems</a></h1>
<p>Kafu supports building applications with any build system, such as CMake.</p>
<p>All you need to do is set <code>$KAFU_SDK_PATH/libexec/kafu_clang</code> as the C/C++ compiler that your build system uses.</p>
<h2 id="example-makefile"><a class="header" href="#example-makefile">Example: Makefile</a></h2>
<p>You can compile a program consisting of <code>main.c</code> as follows:</p>
<pre><code class="language-makefile">CC = $(KAFU_SDK_PATH)/libexec/kafu_clang

all: main.wasm

main.wasm: main.c
	$(CC) $&lt; -o $@

clean:
	rm -f *.wasm

.PHONY: all clean
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="kubernetes-integration"><a class="header" href="#kubernetes-integration">Kubernetes Integration</a></h1>
<p>This guide explains how to deploy Kafu services on Kubernetes clusters. Kafu provides the <code>kafu kustomize</code> command to generate Kubernetes manifests from your Kafu configuration file.</p>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>Before deploying Kafu services to Kubernetes, ensure you have:</p>
<ul>
<li>A running Kubernetes cluster with <code>kubectl</code> configured</li>
<li><a href="https://github.com/kubernetes-sigs/kustomize">Kustomize</a> installed (typically included with <code>kubectl</code>)</li>
<li>Kubernetes nodes labeled with <code>kafu-node</code> matching your node IDs (see <a href="#node-labeling">Node Labeling</a>)</li>
</ul>
<h2 id="configuration-for-kubernetes"><a class="header" href="#configuration-for-kubernetes">Configuration for Kubernetes</a></h2>
<p>When deploying to Kubernetes, you should configure your <code>kafu-config.yaml</code> file with Kubernetes-specific settings:</p>
<h3 id="using-url-for-webassembly-binary"><a class="header" href="#using-url-for-webassembly-binary">Using URL for WebAssembly Binary</a></h3>
<p>For Kubernetes deployments, it’s recommended to use <code>app.url</code> instead of <code>app.path</code> to download the WebAssembly binary from a URL (e.g., from object storage like S3 or GCS). This allows the binary to be accessible from any Pod in the cluster.</p>
<h3 id="using-service-names-for-addresses"><a class="header" href="#using-service-names-for-addresses">Using Service Names for Addresses</a></h3>
<p>In the <code>nodes</code> section, you can use Kubernetes service names for node addresses. The <code>kafu kustomize</code> command generates Services with names following the pattern <code>kafu-server-&lt;node-id&gt;</code>, which can be referenced as:</p>
<ul>
<li><code>kafu-server-&lt;node-id&gt;.&lt;namespace&gt;.svc.cluster.local</code> (fully qualified)</li>
<li><code>kafu-server-&lt;node-id&gt;</code> (within the same namespace)</li>
</ul>
<h3 id="example-configuration"><a class="header" href="#example-configuration">Example Configuration</a></h3>
<pre><code class="language-yaml">name: kafu-k8s-example
app:
  # Use URL for Kubernetes deployments
  url: https://example.com/path/to/main.wasm
  args: [960, 540]
nodes:
  cloud1:
    # Use Kubernetes service name
    address: kafu-server-cloud1.default.svc.cluster.local
    port: 50051
  edge1:
    address: kafu-server-edge1.default.svc.cluster.local
    port: 50051
</code></pre>
<h2 id="generating-kubernetes-manifests"><a class="header" href="#generating-kubernetes-manifests">Generating Kubernetes Manifests</a></h2>
<p>Use the <code>kafu kustomize</code> command to generate Kubernetes manifests from your configuration:</p>
<pre><code class="language-sh">kafu kustomize build kafu-config.yaml
</code></pre>
<p>This command generates Pod and Service resources for each node defined in your configuration. For detailed information about the generated resources, see <a href="#kafu-kustomize">Kafu Kustomize</a>.</p>
<h3 id="saving-the-manifest"><a class="header" href="#saving-the-manifest">Saving the Manifest</a></h3>
<p>You can save the generated manifest to a file:</p>
<pre><code class="language-sh">kafu kustomize build kafu-config.yaml &gt; kafu-manifest.yaml
</code></pre>
<h2 id="deploying-to-kubernetes"><a class="header" href="#deploying-to-kubernetes">Deploying to Kubernetes</a></h2>
<p>Once you have generated the manifest, deploy it to your cluster:</p>
<pre><code class="language-sh"># Apply the manifest
kubectl apply -f kafu-manifest.yaml

# Or pipe directly from kafu kustomize
kafu kustomize build kafu-config.yaml | kubectl apply -f -
</code></pre>
<h3 id="verifying-deployment"><a class="header" href="#verifying-deployment">Verifying Deployment</a></h3>
<p>Check that the Pods and Services are created:</p>
<pre><code class="language-sh"># List Pods
kubectl get pods -l component=kafu-server

# List Services
kubectl get services -l component=kafu-server

# Check Pod logs
kubectl logs -l component=kafu-server --all-containers=true
</code></pre>
<h2 id="node-labeling"><a class="header" href="#node-labeling">Node Labeling</a></h2>
<p>Each Pod generated by <code>kafu kustomize</code> uses a node selector to ensure it runs on the correct Kubernetes node:</p>
<pre><code class="language-yaml">nodeSelector:
  kafu-node: &lt;node-id&gt;
</code></pre>
<p><strong>Important</strong>: You must label your Kubernetes nodes with <code>kafu-node</code> labels matching the node IDs in your configuration:</p>
<pre><code class="language-sh"># Label a node with node ID "cloud1"
kubectl label nodes &lt;node-name&gt; kafu-node=cloud1

# Label a node with node ID "edge1"
kubectl label nodes &lt;node-name&gt; kafu-node=edge1
</code></pre>
<p>Verify the labels:</p>
<pre><code class="language-sh">kubectl get nodes --show-labels | grep kafu-node
</code></pre>
<h2 id="complete-example"><a class="header" href="#complete-example">Complete Example</a></h2>
<p>Here’s a complete workflow for deploying a Kafu service to Kubernetes:</p>
<ol>
<li>
<p><strong>Prepare your WebAssembly binary</strong> and upload it to object storage (e.g., S3, GCS) or a web server.</p>
</li>
<li>
<p><strong>Create <code>kafu-config.yaml</code></strong>:</p>
</li>
</ol>
<pre><code class="language-yaml">name: kafu-k8s-example
app:
  url: https://example.com/path/to/main.wasm
  args: []
nodes:
  cloud1:
    address: kafu-server-cloud1.default.svc.cluster.local
    port: 50051
  edge1:
    address: kafu-server-edge1.default.svc.cluster.local
    port: 50051
</code></pre>
<ol start="3">
<li><strong>Label your Kubernetes nodes</strong>:</li>
</ol>
<pre><code class="language-sh">kubectl label nodes &lt;cloud-node-name&gt; kafu-node=cloud1
kubectl label nodes &lt;edge-node-name&gt; kafu-node=edge1
</code></pre>
<ol start="4">
<li><strong>Generate and apply the manifest</strong>:</li>
</ol>
<pre><code class="language-sh">kafu kustomize build kafu-config.yaml | kubectl apply -f -
</code></pre>
<ol start="5">
<li><strong>Monitor the deployment</strong>:</li>
</ol>
<pre><code class="language-sh">kubectl get pods -l component=kafu-server
kubectl logs -f kafu-server-cloud1
</code></pre>
<h2 id="additional-resources"><a class="header" href="#additional-resources">Additional Resources</a></h2>
<ul>
<li><a href="#kafu-kustomize">Kafu Kustomize</a> - Detailed documentation on the <code>kafu kustomize</code> command</li>
<li><a href="#kafu-config">Kafu Config</a> - Complete configuration file reference</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="kafu-command-line-tools-kafu-cli"><a class="header" href="#kafu-command-line-tools-kafu-cli">Kafu Command Line Tools (Kafu CLI)</a></h1>
<p>Kafu CLI is a set of tools for building, deploying, and running WebAssembly modules with Kafu.</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<pre><code class="language-sh">kafu &lt;subcommand&gt; [args...]
</code></pre>
<p>When you run <code>kafu &lt;subcommand&gt;</code>, the CLI looks up <code>$KAFU_SDK_PATH/libexec/kafu_&lt;subcommand&gt;</code> and executes it, forwarding all remaining arguments.</p>
<h2 id="subcommands"><a class="header" href="#subcommands">Subcommands</a></h2>
<ul>
<li><a href="#kafu-clang">Kafu Clang (<code>clang</code>)</a>: C/C++ compiler wrapper that produces WebAssembly modules</li>
<li><a href="#kafu-serve">Kafu Serve (<code>serve</code>)</a>: Run a Kafu node (gRPC server + WebAssembly runtime)</li>
<li><a href="#kafu-kustomize">Kafu Kustomize (<code>kustomize</code>)</a>: Generate Kubernetes manifests from a Kafu config</li>
<li><a href="#kafu-singlenode">Kafu Singlenode (<code>singlenode</code>)</a>: Run a Kafu service locally in a single-node mode</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="kafu-clang"><a class="header" href="#kafu-clang">Kafu Clang</a></h1>
<p>Kafu Clang is a C/C++ compiler that generates WebAssembly modules.</p>
<h2 id="usage-1"><a class="header" href="#usage-1">Usage</a></h2>
<pre><code class="language-sh">kafu clang [clang args...]
</code></pre>
<p>The binary is located at <code>$KAFU_SDK_PATH/libexec/kafu_clang</code>.</p>
<h2 id="arguments"><a class="header" href="#arguments">Arguments</a></h2>
<ul>
<li><code>clang args...</code> (optional): Arguments passed through to the underlying C/C++ compiler.</li>
</ul>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<pre><code class="language-sh"># Build a single C file into a WebAssembly module (output: a.out by default)
kafu clang main.c

# Specify output name
kafu clang main.c -o main.wasm

# Add include directories
kafu clang main.c -I ./include -o main.wasm
</code></pre>
<h2 id="see-also"><a class="header" href="#see-also">See also</a></h2>
<ul>
<li><a href="../library/kafu-h.html">Kafu SDK headers</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="kafu-serve"><a class="header" href="#kafu-serve">Kafu Serve</a></h1>
<p>The <code>kafu serve</code> command runs a Kafu node in a distributed cluster.</p>
<h2 id="usage-2"><a class="header" href="#usage-2">Usage</a></h2>
<pre><code class="language-sh">kafu serve --node-id &lt;NODE_ID&gt; &lt;CONFIG_PATH&gt;
</code></pre>
<h2 id="arguments-1"><a class="header" href="#arguments-1">Arguments</a></h2>
<ul>
<li>
<p><code>--node-id &lt;NODE_ID&gt;</code> (required): The ID of the node to run. This must match one of the node IDs defined in the configuration file.</p>
</li>
<li>
<p><code>&lt;CONFIG_PATH&gt;</code> (required): Path to the Kafu configuration file.</p>
</li>
</ul>
<h2 id="behavior"><a class="header" href="#behavior">Behavior</a></h2>
<p>The node’s behavior depends on whether <code>&lt;NODE_ID&gt;</code> is the first entry in the config’s <code>nodes</code> section:</p>
<ul>
<li><strong>First node</strong>: starts execution of the configured WebAssembly program.</li>
<li><strong>Other nodes</strong>: wait for incoming migration requests and resume execution when a migration arrives.</li>
</ul>
<h2 id="cluster-liveness-heartbeat"><a class="header" href="#cluster-liveness-heartbeat">Cluster liveness (heartbeat)</a></h2>
<p>By default, <code>kafu serve</code> can perform periodic liveness monitoring between nodes and may shut down nodes depending on the configured policy. You can disable or tune this behavior via <code>cluster.heartbeat</code> in <code>kafu-config.yaml</code> (see <a href="#kafu-config">Kafu Config</a>).</p>
<ul>
<li>
<p><strong>Peer monitoring (first node, optional)</strong>:</p>
<ul>
<li>When enabled, the first node periodically checks whether peers are reachable.</li>
<li>If a peer remains unreachable long enough, the first node requests a cluster-wide shutdown (best effort).</li>
</ul>
</li>
<li>
<p><strong>Coordinator loss handling (non-first nodes, optional)</strong>:</p>
<ul>
<li>When enabled, a non-first node monitors the coordinator (currently: the first node).</li>
<li>Monitoring starts after the coordinator begins program execution.</li>
<li>If the coordinator remains unreachable long enough, the node shuts itself down.</li>
<li>Controlled by <code>cluster.heartbeat.follower_on_coordinator_lost</code>.</li>
</ul>
</li>
</ul>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<p>The server requires a valid Kafu configuration file. For details, see <a href="#kafu-config">Kafu Config</a>.</p>
<h2 id="examples-1"><a class="header" href="#examples-1">Examples</a></h2>
<pre><code class="language-sh"># Start all nodes with the same command
# The first node (cloud1) will automatically start execution
# Other nodes (edge1, edge2) will automatically wait for migration
kafu serve --node-id edge1 kafu-config.yaml
kafu serve --node-id edge2 kafu-config.yaml
kafu serve --node-id cloud1 kafu-config.yaml
</code></pre>
<h2 id="environment"><a class="header" href="#environment">Environment</a></h2>
<ul>
<li><code>RUST_LOG</code> (optional): Controls logging level (e.g., <code>info</code>, <code>debug</code>, <code>warn</code>, <code>error</code>).</li>
</ul>
<h2 id="see-also-1"><a class="header" href="#see-also-1">See also</a></h2>
<ul>
<li><a href="#kafu-config">Kafu Config</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="kafu-singlenode"><a class="header" href="#kafu-singlenode">Kafu Singlenode</a></h1>
<p>The <code>kafu singlenode</code> command runs a Kafu service on a single node by emulating a multi-node environment. This is useful for local development and testing without setting up a distributed cluster.</p>
<h2 id="usage-3"><a class="header" href="#usage-3">Usage</a></h2>
<pre><code class="language-sh">kafu singlenode serve &lt;CONFIG_PATH&gt;
</code></pre>
<h2 id="commands"><a class="header" href="#commands">Commands</a></h2>
<h3 id="serve"><a class="header" href="#serve"><code>serve</code></a></h3>
<p>Starts the Kafu service on a single node using the first node defined in the configuration file.</p>
<pre><code class="language-sh">kafu singlenode serve kafu-config.yaml
</code></pre>
<h2 id="arguments-2"><a class="header" href="#arguments-2">Arguments</a></h2>
<ul>
<li><code>&lt;CONFIG_PATH&gt;</code> (required): Path to the Kafu configuration file.</li>
</ul>
<h2 id="examples-2"><a class="header" href="#examples-2">Examples</a></h2>
<pre><code class="language-sh"># Run a Kafu service in singlenode mode
kafu singlenode serve kafu-config.yaml
</code></pre>
<h2 id="configuration-1"><a class="header" href="#configuration-1">Configuration</a></h2>
<p>The singlenode command uses the same configuration format as <code>kafu serve</code>.</p>
<p>For details about the configuration format, see <a href="#kafu-config">Kafu Config</a>.</p>
<h2 id="environment-1"><a class="header" href="#environment-1">Environment</a></h2>
<ul>
<li><code>RUST_LOG</code> (optional): Controls logging level (e.g., <code>info</code>, <code>debug</code>, <code>warn</code>, <code>error</code>).</li>
</ul>
<h2 id="see-also-2"><a class="header" href="#see-also-2">See also</a></h2>
<ul>
<li><a href="#kafu-config">Kafu Config</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="kafu-kustomize"><a class="header" href="#kafu-kustomize">Kafu Kustomize</a></h1>
<p>The <code>kafu kustomize</code> command generates Kubernetes manifests from a Kafu configuration file.</p>
<blockquote>
<p><strong>Warning</strong>: This feature is experimental and may be broken or behave unexpectedly.</p>
</blockquote>
<h2 id="prerequisites-1"><a class="header" href="#prerequisites-1">Prerequisites</a></h2>
<p>Install <a href="https://github.com/kubernetes-sigs/kustomize">Kustomize</a> and make it available from your terminal.</p>
<p>Kustomize is typically included with <code>kubectl</code>. To verify:</p>
<pre><code class="language-sh">kubectl kustomize version
</code></pre>
<p>Alternatively, you can install Kustomize as a standalone tool:</p>
<pre><code class="language-sh">curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
</code></pre>
<h2 id="usage-4"><a class="header" href="#usage-4">Usage</a></h2>
<pre><code class="language-sh">kafu kustomize build &lt;CONFIG_PATH&gt;
</code></pre>
<h2 id="commands-1"><a class="header" href="#commands-1">Commands</a></h2>
<h3 id="build"><a class="header" href="#build"><code>build</code></a></h3>
<p>Generate Kubernetes manifests to stdout.</p>
<h2 id="arguments-3"><a class="header" href="#arguments-3">Arguments</a></h2>
<ul>
<li><code>&lt;CONFIG_PATH&gt;</code> (required): Path to the Kafu configuration file.</li>
</ul>
<h2 id="output"><a class="header" href="#output">Output</a></h2>
<p>The command outputs a Kubernetes manifest to stdout. You can redirect it to a file:</p>
<pre><code class="language-sh">kafu kustomize build kafu-config.yaml &gt; ./kafu-manifest.yaml
</code></pre>
<p>Or pipe it directly to <code>kubectl</code>:</p>
<pre><code class="language-sh">kafu kustomize build kafu-config.yaml | kubectl apply -f -
</code></pre>
<h2 id="what-it-generates"><a class="header" href="#what-it-generates">What it generates</a></h2>
<p>For each node defined in the config, the generated manifests include:</p>
<ul>
<li>A <strong>Pod</strong> to run the node</li>
<li>A <strong>Service</strong> for node-to-node communication</li>
</ul>
<h2 id="configuration-2"><a class="header" href="#configuration-2">Configuration</a></h2>
<p>The command uses the same configuration format as other Kafu commands. For details, see <a href="#kafu-config">Kafu Config</a>.</p>
<p>For Kubernetes deployments, it’s recommended to use <code>app.url</code> to download WASM modules from a URL (e.g., from object storage like S3 or GCS) rather than <code>app.path</code>.</p>
<h2 id="examples-3"><a class="header" href="#examples-3">Examples</a></h2>
<pre><code class="language-sh"># Generate manifest and save to file
kafu kustomize build kafu-config.yaml &gt; kafu-manifest.yaml

# Apply to Kubernetes cluster
kubectl apply -f kafu-manifest.yaml
</code></pre>
<h2 id="see-also-3"><a class="header" href="#see-also-3">See also</a></h2>
<ul>
<li><a href="#kafu-config">Kafu Config</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="kafu-cc-libraries"><a class="header" href="#kafu-cc-libraries">Kafu C/C++ Libraries</a></h1>
<p>Kafu C/C++ libraries are a set of C/C++ libraries for building Kafu services.</p>
<p><a href="#kafu-clang">Kafu Clang</a> automatically includes these headers.</p>
<h2 id="headers"><a class="header" href="#headers">Headers</a></h2>
<ul>
<li><a href="#kafuh-1">kafu.h</a>: Core Kafu attributes for distributed execution.</li>
<li>kafu_helper.h: Helper functions for tasks such as image processing.</li>
<li>wasi-nn: Functions for running ML inference.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="kafuh-1"><a href="#kafuh-1" class="header">kafu.h</a></h1>
<h2 id="kafuh"><a class="header" href="#kafuh">kafu.h</a></h2>
<p>This header file provides C/C++ macros for executing WebAssembly programs across multiple nodes.</p>
<h2 id="kafu_exportfunc-name"><a class="header" href="#kafu_exportfunc-name"><code>KAFU_EXPORT(&lt;func-name&gt;)</code></a></h2>
<p>This macro exports the annotated function under the name <code>&lt;func-name&gt;</code>.<br>The exported name needs to match the actual C/C++ function symbol.<br>If a different name is used, the same <code>&lt;func-name&gt;</code> must be specified in <code>KAFU_DEST</code>.</p>
<p><strong>Notes</strong></p>
<ul>
<li>Functions annotated with this macro must not be declared as <code>static</code>.</li>
<li>This macro expands to a function attribute and must be placed immediately before the function declaration (prototype). If you don’t have a separate declaration, place it immediately before the function definition.</li>
<li>Multiple distinct functions must not specify the same <code>&lt;func-name&gt;</code>.</li>
</ul>
<hr>
<h2 id="kafu_destfunc-name-node-name"><a class="header" href="#kafu_destfunc-name-node-name"><code>KAFU_DEST(&lt;func-name&gt;, "&lt;node-name&gt;")</code></a></h2>
<p>Specifies that execution of the function identified by <code>&lt;func-name&gt;</code> is dynamically switched to the node <code>&lt;node-name&gt;</code>.</p>
<p><strong>Notes</strong></p>
<ul>
<li><code>&lt;func-name&gt;</code> must match the name specified in <code>KAFU_EXPORT</code>.</li>
</ul>
<p><strong>Example</strong><br>Switch execution to node <code>edge1</code> when calling function <code>f</code>:</p>
<pre><code class="language-c">KAFU_EXPORT(f)
void f() {
    printf("Hello, from edge1!\n");
    fflush(stdout);
}

KAFU_DEST(f, "edge1")
</code></pre>
<p>If <code>f</code> has a declaration, it must be attached with the <code>KAFU_EXPORT</code> attribute:</p>
<pre><code class="language-c">// Declaration
KAFU_EXPORT(f)
void f(void);

// Definition
void f(void) {
    printf("Hello, from edge1!\n");
    fflush(stdout);
}

KAFU_DEST(f, "edge1")
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="kafu-config"><a class="header" href="#kafu-config">Kafu Config</a></h1>
<p>The Kafu configuration file (<code>kafu-config.yaml</code>) defines the structure and deployment settings for a Kafu service. It specifies the WebAssembly binary to execute, the nodes in the distributed cluster, and various runtime parameters.</p>
<h2 id="file-format"><a class="header" href="#file-format">File Format</a></h2>
<p>The configuration file is written in YAML format. By default, Kafu looks for a file named <code>kafu-config.yaml</code> in the current directory, but you can use any filename by passing it explicitly to Kafu commands.</p>
<h2 id="configuration-structure"><a class="header" href="#configuration-structure">Configuration Structure</a></h2>
<h3 id="top-level-fields"><a class="header" href="#top-level-fields">Top-Level Fields</a></h3>
<ul>
<li>
<p><strong><code>name</code></strong> (required): A string identifying the Kafu service. This name must be non-empty and is used for service identification.</p>
</li>
<li>
<p><strong><code>app</code></strong> (required): Application configuration that defines the WebAssembly binary and its execution parameters.</p>
</li>
<li>
<p><strong><code>cluster</code></strong> (optional): Cluster-wide behavior configuration. If omitted, defaults are used (backward compatible).</p>
</li>
<li>
<p><strong><code>nodes</code></strong> (required): A map of node configurations. Each key is a node ID (identifier), and the value is a node configuration. At least one node must be specified. The first node in the map is the node that starts the execution of the WebAssembly binary.</p>
</li>
</ul>
<h3 id="app-configuration"><a class="header" href="#app-configuration">App Configuration</a></h3>
<p>The <code>app</code> section contains the following fields:</p>
<ul>
<li>
<p><strong><code>path</code></strong> (optional): A file path to the WebAssembly binary. If a relative path is specified, it is resolved relative to the directory where the <code>kafu-config.yaml</code> file is located. Either <code>path</code> or <code>url</code> must be specified, but not both.</p>
</li>
<li>
<p><strong><code>url</code></strong> (optional): A URL from which to download the WebAssembly binary. Either <code>path</code> or <code>url</code> must be specified, but not both. This is useful for Kubernetes deployments where the binary is stored in object storage.</p>
</li>
<li>
<p><strong><code>args</code></strong> (optional): A list of strings representing command-line arguments to pass to the WebAssembly binary. Defaults to an empty list if not specified.</p>
</li>
<li>
<p><strong><code>preopened_dir</code></strong> (optional): A directory path that will be preopened for the WebAssembly binary, allowing file system access. If a relative path is specified, it is resolved relative to the directory where the <code>kafu-config.yaml</code> file is located.</p>
</li>
</ul>
<h3 id="node-configuration"><a class="header" href="#node-configuration">Node Configuration</a></h3>
<p>The first node in the <code>nodes</code> map is responsible for starting the execution of the WebAssembly binary. Each node in the <code>nodes</code> map must have the following fields:</p>
<ul>
<li>
<p><strong><code>address</code></strong> (required): A string representing the IP address or hostname of the node. This must be non-empty. For Kubernetes deployments, you can use service names (e.g., <code>kafu-server-edge.default.svc.cluster.local</code>).</p>
</li>
<li>
<p><strong><code>port</code></strong> (required): An integer (u16) representing the port number on which the node listens for Kafu runtime communication.</p>
</li>
</ul>
<h3 id="cluster-configuration"><a class="header" href="#cluster-configuration">Cluster Configuration</a></h3>
<p>The optional <code>cluster</code> section controls cluster-level behavior.</p>
<h4 id="heartbeat-configuration"><a class="header" href="#heartbeat-configuration">Heartbeat Configuration</a></h4>
<p><code>cluster.heartbeat</code> controls heartbeat (health-check) based liveness management:</p>
<ul>
<li>
<p><strong><code>follower_on_coordinator_lost</code></strong> (optional, default: <code>shutdown_self</code>): What non-coordinator nodes should do when the coordinator becomes unreachable for long enough.</p>
<ul>
<li><code>shutdown_self</code>: Shut down this node.</li>
<li><code>ignore</code>: Do nothing.</li>
</ul>
</li>
<li>
<p><strong><code>interval_ms</code></strong> (optional, default: <code>1000</code>): Heartbeat interval in milliseconds (used for both peer monitoring and coordinator monitoring).</p>
</li>
</ul>
<h4 id="migration-configuration"><a class="header" href="#migration-configuration">Migration Configuration</a></h4>
<p><code>cluster.migration</code> controls migration-related options:</p>
<ul>
<li>
<p><strong><code>memory_compression</code></strong> (optional, default: <code>true</code>): Compress main memory with LZ4 when sending, reducing transfer size. This applies to both the delta path (compress changed pages) and the full snapshot path (compress full main memory blob).</p>
</li>
<li>
<p><strong><code>memory_migration</code></strong> (optional, default: <code>delta</code>): Memory migration strategy.</p>
<ul>
<li><code>delta</code>: Send only changed 64KB pages when the receiver has the baseline; otherwise fall back to full.</li>
<li><code>full</code>: Always send full main memory (no delta).</li>
</ul>
</li>
</ul>
<h2 id="example-configuration-1"><a class="header" href="#example-configuration-1">Example Configuration</a></h2>
<h3 id="local-development"><a class="header" href="#local-development">Local Development</a></h3>
<pre><code class="language-yaml"># Name of the Kafu service.
name: kafu-basic-example
app:
  # Path to the Wasm binary to run.
  path: ./main.wasm
  args: [960, 540]
  preopened_dir: .
# Node list in the Kafu cluster.
# The first node (cloud1) starts the execution of the WebAssembly binary.
nodes:
  cloud1: # Node ID (this node starts the Wasm execution)
    # IP address and port of the node.
    address: 127.0.0.1
    # Port of the node.
    port: 50051
  edge1:
    address: 127.0.0.1
    port: 50052

# (Optional) Cluster behavior.
cluster:
  heartbeat:
    # Behavior for non-coordinator nodes when coordinator is lost.
    follower_on_coordinator_lost: shutdown_self   # ignore | shutdown_self
    # Heartbeat interval (ms).
    interval_ms: 1000
  migration:
    # Memory migration strategy: delta | full
    memory_migration: delta
    # Compress memory when sending.
    memory_compression: true
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="development"><a class="header" href="#development">Development</a></h1>
<ul>
<li><a href="#system-architecture">System Architecture</a></li>
<li><a href="#build-from-source">Build from Source</a></li>
<li><a href="#snapify">Snapify</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="system-architecture"><a class="header" href="#system-architecture">System Architecture</a></h1>
<p>This document describes the architecture of Kafu Server (invoked via <code>kafu serve</code>), the core component that executes WebAssembly modules in a distributed Kafu cluster.</p>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>Kafu Server is a gRPC server that executes WebAssembly modules in a distributed cluster. It loads WebAssembly binaries from configuration files and manages runtime migration between nodes based on attributes embedded in the WebAssembly module.</p>
<p><img src="assets/kafu-server-design.png" alt="Kafu Server Architecture"></p>
<h2 id="core-components"><a class="header" href="#core-components">Core Components</a></h2>
<h3 id="grpc-server"><a class="header" href="#grpc-server">gRPC Server</a></h3>
<p>Kafu Server runs as a gRPC server that handles migration requests between nodes. Each node in the cluster communicates via gRPC to transfer execution state.</p>
<h3 id="webassembly-runtime"><a class="header" href="#webassembly-runtime">WebAssembly Runtime</a></h3>
<p>Kafu Server loads and executes WebAssembly binaries using the Kafu runtime (built on Wasmtime). The runtime parses metadata embedded in the module to identify migration points and destination nodes.</p>
<h3 id="kafu-attributes-and-metadata"><a class="header" href="#kafu-attributes-and-metadata">Kafu Attributes and Metadata</a></h3>
<p>Kafu attributes are compile-time annotations that specify where functions should execute. During compilation, these attributes are encoded into WebAssembly custom sections as metadata. At runtime, Kafu Server reads these custom sections to identify migration points and destination nodes.</p>
<h2 id="checkpoint-restore"><a class="header" href="#checkpoint-restore">Checkpoint Restore</a></h2>
<p>Checkpoint Restore is the core mechanism that enables migration between nodes. It allows the runtime to capture (checkpoint) the full execution state on one node and restore it on another node to continue execution seamlessly.</p>
<p>This capability is made possible by <a href="#snapify">Snapify</a>, a WebAssembly binary transformation tool that instruments the wasm module at compile time. Snapify inserts checkpoint/restore logic into the binary so that the runtime can suspend and resume execution at designated migration points.</p>
<h3 id="checkpoint-restore-flow"><a class="header" href="#checkpoint-restore-flow">Checkpoint Restore Flow</a></h3>
<p>When a function annotated for migration is called:</p>
<ol>
<li><strong>Trap at migration point</strong>: The function execution triggers a migration point inserted by <a href="#snapify">Snapify</a></li>
<li><strong>Checkpoint state</strong>: The runtime captures the current execution state:
<ul>
<li>Stack state (via Asyncify)</li>
<li>Global variables</li>
<li>Memory contents</li>
</ul>
</li>
<li><strong>Send migration request</strong>: The source node sends a gRPC request to the destination node with the checkpointed state</li>
<li><strong>Restore on destination</strong>: The destination node restores the state and continues execution</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="build-from-source"><a class="header" href="#build-from-source">Build from Source</a></h1>
<h2 id="prerequisites-2"><a class="header" href="#prerequisites-2">Prerequisites</a></h2>
<ul>
<li>Rust</li>
</ul>
<pre><code class="language-sh">sudo apt-get install -y --no-install-recommends \
    build-essential pkg-config libssl-dev openssl protobuf-compiler
</code></pre>
<h2 id="build-1"><a class="header" href="#build-1">Build</a></h2>
<p>Build all crates:</p>
<pre><code class="language-sh">cargo build --workspace
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="snapify"><a class="header" href="#snapify">Snapify</a></h1>
<h2 id="overview-2"><a class="header" href="#overview-2">Overview</a></h2>
<p>Snapify is a <a href="https://github.com/tamaroning/binaryen/tree/snapify">Binaryen</a> (a.k.a. wasm-opt) Pass that enables checkpoint/restore functionality for Wasm modules. When used in combination with Asyncify, it allows saving and restoring the state of a running Wasm program.</p>
<p>You can find the source code at <a href="https://github.com/tamaroning/binaryen/blob/snapify/src/passes/Snapify.cpp">https://github.com/tamaroning/binaryen/blob/snapify/src/passes/Snapify.cpp</a>.</p>
<p>Snapify is installed as <code>$KAFU_SDK_PATH/libexec/kafu_wasm-opt</code>.</p>
<h2 id="usage-5"><a class="header" href="#usage-5">Usage</a></h2>
<p>Apply the Snapify pass to a Wasm module, then apply Asyncify:</p>
<pre><code class="language-bash">$(WASM_OPT) foo.wasm -O1 --enable-multimemory --snapify \
  --pass-arg=policy@always -o foo2.wasm
$(WASM_OPT) foo2.wasm -O1 --asyncify \
  --pass-arg=asyncify-memory@snapify_memory \
  --enable-multimemory -o output.wasm
</code></pre>
<h2 id="how-it-works"><a class="header" href="#how-it-works">How It Works</a></h2>
<p>Snapify Pass inserts migration points at both the beginning and the end of functions. These migration points check whether a checkpoint is needed and coordinate with Asyncify to unwind/rewind the stack.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="license"><a class="header" href="#license">License</a></h1>
<h2 id="kafu-sdk-license"><a class="header" href="#kafu-sdk-license">Kafu SDK License</a></h2>
<p>Kafu SDK is licensed under either of:</p>
<ul>
<li><strong>MIT License</strong></li>
<li><strong>Apache License, Version 2.0, with LLVM Exception</strong></li>
</ul>
<p>at your option.</p>
<p>For the full license text, please see the <a href="https://github.com/tamaroning/kafu/blob/main/LICENSE">LICENSE</a> file in the repository root.</p>
<h2 id="binaries-generated-by-kafu-clang"><a class="header" href="#binaries-generated-by-kafu-clang">Binaries Generated by Kafu Clang</a></h2>
<p>Binaries generated by Kafu Clang have <strong>wasi-libc</strong> statically linked.</p>
<p>When using, distributing, or modifying generated binaries, you must comply with the <strong>wasi-libc license</strong>. For detailed information and the full license text, please refer to the <a href="https://github.com/WebAssembly/wasi-libc">WebAssembly / wasi-libc</a> repository.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="grocery"><a class="header" href="#grocery">Grocery</a></h1>
<p>Useful links for those who are interested in the design behind Kafu.</p>
<ul>
<li>WebAssembly Specifications (<a href="https://webassembly.github.io/spec/">link</a>).</li>
<li>wasi-nn (<a href="https://github.com/WebAssembly/wasi-nn">link</a>).</li>
<li>Emscripten (<a href="https://emscripten.org/">link</a>).</li>
<li>Cross-Site Edge Framework for Location-Awareness Distributed Edge-Computing Application (<a href="https://ieeexplore.ieee.org/document/9126749">paper</a>).</li>
<li>Nomad: Cross-Platform Computational Offloading and Migration in Femtoclouds Using WebAssembly (<a href="https://ieeexplore.ieee.org/document/9610311">paper</a>).</li>
<li>Bringing Together Cross-ISA Checkpoint/Restoration and AOT Compilation of WebAssembly Programs (<a href="https://dl.acm.org/doi/abs/10.1145/3759426.3760985">paper</a>).</li>
<li>Pause and Resume WebAssembly with Binaryen’s Asyncify (<a href="https://kripken.github.io/blog/wasm/2019/07/16/asyncify.html">blog</a>).</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
