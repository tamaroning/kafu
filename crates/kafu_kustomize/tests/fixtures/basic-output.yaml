apiVersion: v1
kind: ConfigMap
metadata:
  name: kafu-config
data:
  kafu-config.yaml: |
    name: basic
    app:
      path: ./main.wasm
      url: null
      args: []
      preopened_dir: .
    nodes:
      node1:
        address: kafu-server-node1
        port: 50051
        placement: null
      node2:
        address: kafu-server-node2
        port: 50052
        placement: null
      node3:
        address: kafu-server-node3
        port: 50053
        placement: null
    cluster:
      heartbeat:
        follower_on_coordinator_lost: shutdown_self
        interval_ms: 1000
      migration:
        memory_compression: true
        memory_migration: delta
---
apiVersion: v1
kind: Service
metadata:
  name: kafu-server-node1
spec:
  clusterIP: None
  ports:
  - port: 50051
  selector:
    component: kafu-server
---
apiVersion: v1
kind: Pod
metadata:
  labels:
    component: kafu-server
  name: kafu-server-node1
spec:
  containers:
  - command:
    - kafu_serve
    - --node-id
    - node1
    - /etc/kafu/kafu-config.yaml
    env:
    - name: RUST_LOG
      value: info
    image: ghcr.io/tamaroning/kafu
    imagePullPolicy: IfNotPresent
    name: kafu-server
    volumeMounts:
    - mountPath: /etc/kafu
      name: kafu-config
      readOnly: true
  nodeSelector:
    kafu-node: node1
  volumes:
  - configMap:
      name: kafu-config
    name: kafu-config
---
apiVersion: v1
kind: Service
metadata:
  name: kafu-server-node2
spec:
  clusterIP: None
  ports:
  - port: 50051
  selector:
    component: kafu-server
---
apiVersion: v1
kind: Pod
metadata:
  labels:
    component: kafu-server
  name: kafu-server-node2
spec:
  containers:
  - command:
    - kafu_serve
    - --node-id
    - node2
    - /etc/kafu/kafu-config.yaml
    env:
    - name: RUST_LOG
      value: info
    image: ghcr.io/tamaroning/kafu
    imagePullPolicy: IfNotPresent
    name: kafu-server
    volumeMounts:
    - mountPath: /etc/kafu
      name: kafu-config
      readOnly: true
  nodeSelector:
    kafu-node: node2
  volumes:
  - configMap:
      name: kafu-config
    name: kafu-config
---
apiVersion: v1
kind: Service
metadata:
  name: kafu-server-node3
spec:
  clusterIP: None
  ports:
  - port: 50051
  selector:
    component: kafu-server
---
apiVersion: v1
kind: Pod
metadata:
  labels:
    component: kafu-server
  name: kafu-server-node3
spec:
  containers:
  - command:
    - kafu_serve
    - --node-id
    - node3
    - /etc/kafu/kafu-config.yaml
    env:
    - name: RUST_LOG
      value: info
    image: ghcr.io/tamaroning/kafu
    imagePullPolicy: IfNotPresent
    name: kafu-server
    volumeMounts:
    - mountPath: /etc/kafu
      name: kafu-config
      readOnly: true
  nodeSelector:
    kafu-node: node3
  volumes:
  - configMap:
      name: kafu-config
    name: kafu-config
